!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.momo=t()}(this,function(){"use strict";function e(e){return e|=0,void 0!==he[e]?he[e]:void 0!==Le[e]?Le[e]:void 0!==Ae[e]?Ae[e]:void 0!==Fe[e]?Fe[e]:"undefined"}function t(){this.node=null,this.index=0,this.parent=null,this.symbols={},this.localIndex=0,this.resolve=function(e){return this.symbols[e]?this.symbols[e]:this.parent?this.parent.resolve(e):(ge.__imports.error(e+" is not defined"),null)},this.register=function(e,t){if(t.kind!==he.FunctionDeclaration){if(void 0!==this.symbols[e]&&ge.__imports.error("Symbol "+e+" is already defined"),this.symbols[e]=t,null!==this.parent&&(t.kind===he.VariableDeclaration||t.kind===he.Parameter)){let e=n(this);t.index=e.localIndex++}}else this.registerFunction(e,t)},this.registerFunction=function(e,t){let n=this.symbols[e]||null;n&&(n.type!==t.type&&ge.__imports.error(`Conflicting types for '${e}'`),n.isPrototype||t.isPrototype||ge.__imports.error(`Redefinition of '${e}'`)),this.symbols[e]=t}}function n(e){let t=e;for(;null!==t&&t.node.kind!==he.FunctionDeclaration;)t=t.parent;return t}function i(e){let n=new t;n.node=e,n.parent=ge.scope,n.index=ge.scope?ge.scope.index+1:0,e.context=n,ge.scope=n}function r(){null!==ge.scope&&(ge.scope=ge.scope.parent)}function _(e,t){let n=ge.scope;for(;null!==n&&(!n||n.node.kind!==t);)n=n.parent;null===n&&null!==t&&ge.__imports.error("Invalid scope of node "+e.kind+", expected",t)}function s(t){let n=t.kind;switch(n){case he.BinaryExpression:return o(t);case he.Literal:return O(t);default:ge.__imports.error(`Unexpected node kind ${e(n)}`)}return 0}function O(e){switch(e.type){case Le.NumericLiteral:case Le.HexadecimalLiteral:return parseInt(e.value);case Le.Identifier:return ge.scope.resolve(e.value).resolvedValue}}function o(e){let t=e.operator,n=s(e.left),i=s(e.right);switch(t){case"+":return n+i;case"-":return n-i;case"*":return n*i;case"/":return n/i;case"%":return n%i;case"^":return n^i;case"&":return n&i;case"|":return n|i;case"<<":return n<<i;case">>":return n>>i;case"||":return 0|(n||i);case"&&":return 0|(n&&i);case"==":return n==i|0;case"!=":return n!=i|0;case"<":return n<i|0;case"<=":return n<=i|0;case">":return n>i|0;case">=":return n>=i|0}}function a(e){let t=e.kind;return(t===Fe.ASS||t===Fe.ADD||t===Fe.SUB||t===Fe.MUL||t===Fe.DIV||t===Fe.MOD||t===Fe.OR||t===Fe.AND||t===Fe.BIN_AND||t===Fe.BIN_OR||t===Fe.BIN_XOR||t===Fe.BIN_SHL||t===Fe.BIN_SHR||t===Fe.NOT||t===Fe.LT||t===Fe.LE||t===Fe.GT||t===Fe.GE||t===Fe.EQ||t===Fe.NEQ||t===Fe.ADD_ASS||t===Fe.SUB_ASS||t===Fe.MUL_ASS||t===Fe.DIV_ASS||t===Fe.MOD_ASS||t===Fe.BIN_AND_ASS||t===Fe.BIN_OR_ASS||t===Fe.BIN_XOR_ASS||t===Fe.BIN_SHL_ASS||t===Fe.BIN_SHR_ASS)&&t!==Fe.NOT&&t!==Fe.INCR&&t!==Fe.DECR}function E(e){return e===Fe.ASS||e===Fe.ADD_ASS||e===Fe.SUB_ASS||e===Fe.MUL_ASS||e===Fe.DIV_ASS||e===Fe.MOD_ASS||e===Fe.BIN_AND_ASS||e===Fe.BIN_OR_ASS||e===Fe.BIN_XOR_ASS||e===Fe.BIN_SHL_ASS||e===Fe.BIN_SHR_ASS}function u(e){let t=e.kind;return t===Fe.BIN_AND||t===Fe.MUL||t===Fe.BIN_NOT||t===Fe.SUB||t===Fe.ADD||t===Fe.NOT||t===Fe.INCR||t===Fe.DECR}function c(e){let t=e.kind;return t===Fe.INCR||t===Fe.DECR}function l(e){let t=e.kind;return t===Le.NumericLiteral||t===Le.HexadecimalLiteral||t===Le.BooleanLiteral||t===Le.Identifier}function C(e){let t=e.kind;return t===Ae.INT||t===Ae.INT32||t===Ae.INT64||t===Ae.FLOAT||t===Ae.FLOAT32||t===Ae.FLOAT64||t===Ae.VOID||t===Ae.BOOLEAN}function f(e){ge.tokens=e,ge.pindex=-1,P();let t={kind:he.Program,body:null};return i(t),ge.global=ge.scope,t.body=p(),t}function D(e){return ge.current&&ge.current.kind===e}function P(){ge.pindex++,ge.current=ge.tokens[ge.pindex]}function m(t){const{current:n,__imports:i}=ge;n.kind!==t?i.error("Expected "+e(t)+" but got "+e(n.kind)+" in "+n.line+":"+n.column):P()}function I(){const{current:t,__imports:n}=ge;t.kind!==Le.IDENTIFIER&&n.error("Expected "+Le.IDENTIFIER+":identifier but got "+e(t.kind)+":"+t.value)}function y(e){return!!D(e)&&(P(),!0)}function p(){let e={kind:he.BlockStatement,body:[],context:ge.scope};for(;;){if(!ge.current)break;if(D(Ae.RBRACE))break;let t=S();if(null===t)break;e.body.push(t)}return e}function S(){const{current:e,__imports:t}=ge;let n=null;return y(Ae.EXPORT)?n=d(!0):D(Ae.ENUM)?n=U():C(e)?n=d(!1):D(Ae.RETURN)?n=N():D(Ae.IF)?n=R():D(Ae.WHILE)?n=b():null===(n=H(Fe.LOWEST))&&t.error("Unknown node kind "+e.value+" in "+e.line+":"+e.column),y(Ae.SEMICOLON),n}function U(){m(Ae.ENUM);let e={kind:he.EnumDeclaration,name:null,items:[]};D(Le.Identifier)&&(e.name=ge.current.value,P()),m(Ae.LBRACE);let t=0;for(;;){I();let n={kind:he.Enumerator,name:ge.current.value,init:null};if(P(),y(Fe.ASS)){let e=H(Fe.LOWEST);n.init=e,n.resolvedValue=s(e),t=n.resolvedValue}else n.resolvedValue=t;if(e.items.push(n),ge.scope.register(n.name,n),y(Ae.COMMA),D(Ae.RBRACE))break;t++}return m(Ae.RBRACE),e}function d(e){let t=null;x();const n=ge.current.kind;P();let i=y(Fe.MUL),r=!1;i||(r=y(Fe.BIN_AND)),I();const _=ge.current.value;return P(),ge.current.kind===Fe.ASS?t=F(n,_,e,i,r):Ae.LPAREN?t=h(n,_,e):(t=null,ge.__imports.error("Invalid keyword: "+ge.current.value)),t}function b(){let e={kind:he.WhileStatement,condition:null,body:null};return m(Ae.WHILE),e.condition=H(Fe.LOWEST),y(Ae.LBRACE)?(i(e),e.body=p(),r(),m(Ae.RBRACE)):e.body=H(Fe.LOWEST),e}function R(){let e={kind:he.IfStatement,condition:null,alternate:null,consequent:null};return y(Ae.IF)?(m(Ae.LPAREN),e.condition=H(Fe.LOWEST),m(Ae.RPAREN),i(e),e.consequent=T(),r(),y(Ae.ELSE)&&(e.alternate=R()),e):(i(e),e.consequent=T(),r(),e)}function T(){let e=null;return y(Ae.LBRACE)?(e=p(),m(Ae.RBRACE)):((e=[]).push(H(Fe.LOWEST)),y(Ae.SEMICOLON)),e}function N(){m(Ae.RETURN);let e={kind:he.ReturnStatement,argument:null};D(Ae.SEMICOLON)||(e.argument=H(Fe.LOWEST)),_(e,he.FunctionDeclaration);let t=ge.scope;for(;null!==t&&(!t||t.node.kind!==he.FunctionDeclaration);)t=t.parent;return t.node.returns.push(e),e}function h(e,t,n){let s={index:0,isExported:!!n,kind:he.FunctionDeclaration,type:e,id:t,locals:[],returns:[],parameter:null,prototype:null,body:null};if(_(s,null),s.parameter=L(s),s.isPrototype=!y(Ae.LBRACE),ge.scope.register(t,s),s.isPrototype||(i(s),s.parameter.map(e=>{ge.scope.register(e.value,e)}),s.body=p(),r(),m(Ae.RBRACE)),null===s.prototype||s.type===Ae.VOID||s.returns.length||ge.__imports.error("Missing return in function: "+s.id),!s.returns.length&&s.type===Ae.VOID){let e={kind:he.ReturnStatement,argument:null};s.returns.push(e),s.body.body.push(e)}if("main"===s.id&&!s.returns.length){let e={kind:he.ReturnStatement,argument:{kind:he.Literal,type:Le.NumericLiteral,value:"0"}};s.returns.push(e),s.body.body.push(e)}return s}function L(e){let t=[];e.prototype;for(m(Ae.LPAREN);;){if(D(Ae.RPAREN))break;let n=A(e);if(t.push(n),!y(Ae.COMMA))break}return m(Ae.RPAREN),t}function A(e){let t=null;C(ge.current)?(t=ge.current.kind,P()):ge.__imports.error("Missing type for parameter in",e.id);let n=y(Fe.MUL),i=!1;n||(i=y(Fe.BIN_AND)),I();let r=ge.current;return r.type=t,r.kind=he.Parameter,r.isParameter=!0,r.isPointer=n,r.isReference=i,P(),r}function F(e,t,i,r,O){let o={kind:he.VariableDeclaration,type:e,id:t,init:null,isGlobal:!1,isPointer:r,isAlias:O};i&&_(o,null),ge.scope.register(o.id,o),null===ge.scope.parent&&(o.isGlobal=!0),m(Fe.ASS);let a=H(Fe.LOWEST);if(o.init={kind:he.BinaryExpression,left:{kind:he.Literal,type:Le.Identifier,value:o.id},right:a,operator:"="},O&&(o.aliasValue=a,o.aliasReference={kind:he.UnaryPrefixExpression,operator:"&",value:o.aliasValue}),o.isGlobal)o.resolvedValue=s(o.init.right);else{let e=n(ge.scope).node;e.locals.push(o)}return o}function B(e){return{kind:he.CallExpression,callee:e,parameter:k(e.value)}}function k(e){let t=[];ge.scope.resolve(e);m(Ae.LPAREN);let n=0;for(;;){if(D(Ae.RPAREN))break;let e=H(Fe.LOWEST);if(t.push(e),!y(Ae.COMMA))break;n++}return m(Ae.RPAREN),t}function v(){let e={kind:he.BreakStatement};return m(Ae.BREAK),_(e,he.WhileStatement),e}function g(){let e={kind:he.ContinueStatement};return m(Ae.CONTINUE),_(e,he.WhileStatement),e}function x(){C(ge.current)||ge.__imports.error("Expected type literal but got "+ge.current.kind)}function M(){let e={kind:he.UnaryPrefixExpression,operator:ge.current.value,value:null};return P(),e.value=H(Fe.UNARY_PREFIX),e}function V(e){let t={kind:he.UnaryPostfixExpression,operator:ge.current.value,value:e};return P(),t}function G(){if(l(ge.current))return W();if(y(Ae.LPAREN)){let e=H(Fe.LOWEST);return m(Ae.RPAREN),e}return u(ge.current)?M():H(Fe.LOWEST)}function w(e,t){let n=ge.current.value,i=Fe[n];if(e>i)return t;let r={kind:he.BinaryExpression,left:t,right:null,operator:n};P(),r.right=H(i);let _=Fe[n];if(E(_)&&_!==Fe.ASS){let e={kind:he.BinaryExpression,left:r.left,operator:"=",right:{kind:he.BinaryExpression,operator:n.slice(0,n.length-1),left:r.left,right:r.right}};r=e}return r}function Y(e,t){return a(ge.current)?w(e,t):c(ge.current)?e>=Fe.UNARY_POSTFIX?t:V(t):D(Ae.LPAREN)?B(t):t}function H(e){if(D(Ae.BREAK))return v();if(D(Ae.CONTINUE))return g();let t=G();for(;;){if(!ge.current)break;let n=Y(e,t);if(null===n||n===t)break;t=n}return t}function W(){let e=ge.current.value;ge.current.kind===Le.IDENTIFIER&&ge.scope.resolve(e);let t={kind:he.Literal,type:ge.current.kind,value:e};return P(),t}function X(e){return 9===e||11===e||12===e||32===e||160===e}function Q(e){return e>=65&&e<=90||e>=97&&e<=122||95===e}function K(e){return e>=48&&e<=57}function Z(e){return K(e)||e>=97&&e<=102}function q(e){return"("===e||")"===e||"{"===e||"}"===e||","===e||";"===e}function j(e){return"="===e||"+"===e||"-"===e||"%"===e||"!"===e||"|"===e||"&"===e||"~"===e||"^"===e||">"===e||"<"===e||"*"===e||"/"===e}function z(e){return 1===e.length?j(e):"++"===e||"--"===e||"=="===e||">="===e||"<="===e||"!="===e||"||"===e||"&&"===e||"<<"===e||">>"===e||"+="===e||"-="===e||"*="===e||"/="===e||"%="===e||"^="===e||"&="===e||"|="===e||"^="===e||"<<="===e||">>="===e}function J(e,t,n,i){let r=Le.UNKNOWN,_=$(r=Ae[t]>=0?Ae[t]:Fe[t]>=0?Fe[t]:Le.Identifier,t,n,i-t.length);return e.push(_),_}function $(e,t,n,i){return{kind:e,value:t,line:n,column:i}}function ee(e){function t(){n++,r++}let n=-1,i=1,r=0,_=e.length,s=[];for(;;){t();let O=e.charAt(n),o=e.charCodeAt(n);if(!X(o))if(10!==o)if(Q(o)){let _=n;for(;;){if(!Q(o)&&!K(o)){n--,r--;break}t(),o=e.charCodeAt(n)}let O=e.slice(_,n+1);J(s,O,i,r)}else if(K(o)){if("x"===e.charAt(n+1)){let _=n;for(t();;){if(!Z(o)){n--,r--;break}t(),o=e.charCodeAt(n)}let O=e.slice(_,n+1),a=$(Le.HexadecimalLiteral,O,i,r);s.push(a);continue}let _=n;for(;;){if(!K(o)&&45!==o){n--,r--;break}t(),o=e.charCodeAt(n)}let O=e.slice(_,n+1),a=$(Le.NumericLiteral,O,i,r);s.push(a)}else if("/"!==O||"/"!==e[n+1]){if(q(O)){let t=e.slice(n,n+1);J(s,t,i,r)}else if(j(O))!function(n,i,r,_){let O=e.slice(i+1,i+2),o=e.slice(i+2,i+3);O&&z(n+O)?o&&z(n+O+o)?(t(),t(),J(s,n+O+o,r,_)):(t(),J(s,n+O,r,_)):z(n)&&J(s,n,r,_)}(O,n,i,r);else if(n>=_)break}else for(;;){if(10===o){r=0,i++;break}t(),o=e.charCodeAt(n)}else i++,r=0}return s}function te(e){switch(e){case Ae.VOID:return Be.TYPE_CTOR_VOID;case Ae.INT:case Ae.INT32:return Be.TYPE_CTOR_I32;case Ae.INT64:return Be.TYPE_CTOR_I64;case Ae.FLOAT:case Ae.FLOAT32:return Be.TYPE_CTOR_I32;case Ae.FLOAT64:return Be.TYPE_CTOR_F64;case Ae.BOOL:return Be.TYPE_CTOR_I32}return-1}function ne(e){switch(e){case"+":return Be.OPCODE_I32_ADD;case"-":return Be.OPCODE_I32_SUB;case"*":return Be.OPCODE_I32_MUL;case"/":return Be.OPCODE_I32_DIV_S;case"%":return Be.OPCODE_I32_REM_S;case"^":return Be.OPCODE_I32_XOR;case"|":return Be.OPCODE_I32_OR;case"&":return Be.OPCODE_I32_AND;case"<":return Be.OPCODE_I32_LT_S;case"<=":return Be.OPCODE_I32_LE_S;case">":return Be.OPCODE_I32_GT_S;case">=":return Be.OPCODE_I32_GE_S;case"==":return Be.OPCODE_I32_EQ;case"!=":return Be.OPCODE_I32_NEQ;case"&&":return Be.OPCODE_I32_AND;case"||":return Be.OPCODE_I32_OR;case"<<":return Be.OPCODE_I32_SHL;case">>":return Be.OPCODE_I32_SHR_S;default:return-1}}function ie(e){ge.scope=e.context,ge.bytes.emitU32(Be.MAGIC),ge.bytes.emitU32(Be.VERSION),re(e.body),_e(e.body),se(e.body),oe(e),ae(e.body),Ee(e.body),ue(e.body),ce(e.body)}function re(e){ge.bytes.emitU8(Be.SECTION_TYPE);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==he.FunctionDeclaration||e.isPrototype||(ge.bytes.emitU8(Be.TYPE_CTOR_FUNC),ge.bytes.writeVarUnsigned(e.parameter.length),e.parameter.map(e=>{ge.bytes.emitU8(te(e.type))}),e.type!==Ae.VOID?(ge.bytes.emitU8(1),ge.bytes.emitU8(te(e.type))):ge.bytes.emitU8(0),e.index=i,i++)}),n.patch(i),t.patch(ge.bytes.length-t.offset)}function _e(e){ge.bytes.emitU8(Be.SECTION_FUNCTION);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==he.FunctionDeclaration||e.isPrototype||(i++,ge.bytes.writeVarUnsigned(e.index))}),n.patch(i),t.patch(ge.bytes.length-t.offset)}function se(e){ge.bytes.emitU8(Be.SECTION_TABLE);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch();Oe(e),n.patch(1),t.patch(ge.bytes.length-t.offset)}function Oe(e){ge.bytes.emitU8(Be.TYPE_CTOR_ANYFUNC),ge.bytes.emitU8(1);let t=0;e.body.map(e=>{e.kind!==he.FunctionDeclaration||e.isPrototype||t++}),ge.bytes.writeVarUnsigned(t),ge.bytes.writeVarUnsigned(t)}function oe(e){ge.bytes.emitU8(Be.SECTION_MEMORY);let t=ge.bytes.createU32vPatch();ge.bytes.emitU32v(1),ge.bytes.emitU32v(0),ge.bytes.emitU32v(1),t.patch(ge.bytes.length-t.offset)}function ae(e){ge.bytes.emitU8(Be.SECTION_GLOBAL);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch(),i=0;e.body.map(e=>{if(e.kind===he.VariableDeclaration&&e.isGlobal){let t=e.init.right;e.index=i++,ge.bytes.emitU8(te(e.type)),ge.bytes.emitU8(1),xe?(ge.bytes.emitU8(Be.OPCODE_I32_CONST),ge.bytes.emitLEB128(e.resolvedValue)):Ce(t),ge.bytes.emitU8(Be.OPCODE_END)}else e.kind===he.EnumDeclaration&&(e.index=i++,ge.bytes.emitU8(Be.TYPE_CTOR_I32),ge.bytes.emitU8(1),ge.bytes.emitU8(Be.OPCODE_I32_CONST),ge.bytes.emitLEB128(e.resolvedValue),ge.bytes.emitU8(Be.OPCODE_END))}),n.patch(i),t.patch(ge.bytes.length-t.offset)}function Ee(e){ge.bytes.emitU8(Be.SECTION_EXPORT);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==he.FunctionDeclaration||e.isPrototype||(e.isExported||"main"===e.id)&&(i++,ge.bytes.emitString(e.id),ge.bytes.emitU8(Be.EXTERN_FUNCTION),ge.bytes.writeVarUnsigned(e.index))}),(()=>{i++;ge.bytes.emitString("memory");ge.bytes.emitU8(Be.EXTERN_MEMORY);ge.bytes.emitU8(0)})(),n.patch(i),t.patch(ge.bytes.length-t.offset)}function ue(e){ge.bytes.emitU8(Be.SECTION_ELEMENT);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==he.FunctionDeclaration||e.isPrototype||(ge.bytes.writeVarUnsigned(0),ge.bytes.emitUi32(e.index),ge.bytes.emitU8(Be.OPCODE_END),ge.bytes.writeVarUnsigned(1),ge.bytes.writeVarUnsigned(e.index),i++)}),n.patch(i),t.patch(ge.bytes.length-t.offset)}function ce(e){ge.bytes.emitU8(Be.SECTION_CODE);let t=ge.bytes.createU32vPatch(),n=ge.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==he.FunctionDeclaration||e.isPrototype||(Re(e),i++)}),n.patch(i),t.patch(ge.bytes.length-t.offset)}function le(e){ge.currentHeapOffset+=e}function Ce(e){let t=e.kind;if(t===he.BlockStatement){let t=e.context.node,n=t.kind===he.IfStatement||t.kind===he.WhileStatement||t.kind===he.FunctionDeclaration;e.context&&(ge.scope=e.context),n||(ge.bytes.emitU8(Be.OPCODE_BLOCK),ge.bytes.emitU8(Be.TYPE_CTOR_BLOCK)),e.body.map(e=>{Ce(e)}),n||ge.bytes.emitU8(Be.OPCODE_END),e.context&&(ge.scope=ge.scope.parent)}else if(t===he.IfStatement)e.condition&&(Ce(e.condition),ge.bytes.emitU8(Be.OPCODE_IF),ge.bytes.emitU8(Be.TYPE_CTOR_BLOCK)),Ce(e.consequent),e.alternate&&(ge.bytes.emitU8(Be.OPCODE_ELSE),Ce(e.alternate)),e.condition&&ge.bytes.emitU8(Be.OPCODE_END);else if(t===he.ReturnStatement)e.argument&&Ce(e.argument),ge.bytes.emitU8(Be.OPCODE_RETURN);else if(t===he.CallExpression){let t=e.callee.value,n=ge.scope.resolve(t);e.parameter.map(e=>{Ce(e)}),n.isPointer?(ge.bytes.emitUi32(n.offset),ge.bytes.emitLoad32(),ge.bytes.emitU8(Be.OPCODE_CALL_INDIRECT),ge.bytes.writeVarUnsigned(0),ge.bytes.emitU8(0)):(ge.bytes.emitU8(Be.OPCODE_CALL),ge.bytes.writeVarUnsigned(n.index))}else if(t===he.VariableDeclaration)pe(e);else if(t===he.WhileStatement)ge.bytes.emitU8(Be.OPCODE_BLOCK),ge.bytes.emitU8(Be.TYPE_CTOR_BLOCK),ge.bytes.emitU8(Be.OPCODE_LOOP),ge.bytes.emitU8(Be.TYPE_CTOR_BLOCK),Ce(e.condition),ge.bytes.emitU8(Be.OPCODE_I32_EQZ),ge.bytes.emitU8(Be.OPCODE_BR_IF),ge.bytes.emitU8(1),Ce(e.body),ge.bytes.emitU8(Be.OPCODE_BR),ge.bytes.emitU8(0),ge.bytes.emitU8(Be.OPCODE_UNREACHABLE),ge.bytes.emitU8(Be.OPCODE_END),ge.bytes.emitU8(Be.OPCODE_END);else if(t===he.BreakStatement){ge.bytes.emitU8(Be.OPCODE_BR);let e=Ue();ge.bytes.writeVarUnsigned(e),ge.bytes.emitU8(Be.OPCODE_UNREACHABLE)}else if(t===he.ContinueStatement){ge.bytes.emitU8(Be.OPCODE_BR);let e=Ue();ge.bytes.writeVarUnsigned(e-1),ge.bytes.emitU8(Be.OPCODE_UNREACHABLE)}else if(t===he.Literal)e.type===Le.Identifier?ye(e):e.type===Le.NumericLiteral||e.type===Le.HexadecimalLiteral?(ge.bytes.emitU8(Be.OPCODE_I32_CONST),ge.bytes.emitLEB128(parseInt(e.value))):ge.__imports.error("Unknown literal type "+e.type);else if(t===he.UnaryPrefixExpression)de(e);else if(t===he.UnaryPostfixExpression)be(e);else if(t===he.BinaryExpression){let t=e.operator;"="===t?Ie(e):"&&"===t||"||"===t?(Ce(e.left),ge.bytes.emitUi32(1),ge.bytes.emitU8(Be.OPCODE_I32_GE_S),Ce(e.right),ge.bytes.emitUi32(1),ge.bytes.emitU8(Be.OPCODE_I32_GE_S),ge.bytes.emitU8(ne(t))):(Ce(e.left),Ce(e.right),ge.bytes.emitU8(ne(t)))}else ge.__imports.error("Unknown node kind "+t)}function fe(e){return e.kind===he.UnaryPrefixExpression?fe(e.value):e}function De(t){let n=fe(t),i=ge.scope.resolve(n.value);if(i.isPointer){let r=t.value;r.type===Le.Identifier?ge.bytes.emitUi32(i.offset):"*"===r.operator?Ce(n):ge.__imports.log("Unsupported adress-of value",e(r.kind))}else i.kind===he.FunctionDeclaration?ge.bytes.emitUi32(i.index):i.isAlias?Ce(i.aliasReference):ge.bytes.emitUi32(i.offset)}function Pe(e){Ce(e.value),ge.bytes.emitLoad32()}function me(e){Ce(e.left.value),Ce(e.right),ge.bytes.emitStore32()}function Ie(e){e.left;if("*"===e.left.operator)return void me(e);let t=ge.scope.resolve(e.left.value);"="===e.right.operator?(Ce(e.right),Ce(e.right.left)):t.isGlobal?(Ce(e.right),ge.bytes.emitU8(Be.OPCODE_SET_GLOBAL),ge.bytes.writeVarUnsigned(t.index)):t.isAlias?Ce({kind:he.BinaryExpression,operator:"=",left:t.aliasValue,right:e.right}):Me?Ce(e.right):(ge.bytes.emitUi32(t.offset),Ce(e.right),ge.bytes.emitStore32())}function ye(t){let n=ge.scope.resolve(t.value);n.isGlobal?(ge.bytes.emitU8(Be.OPCODE_GET_GLOBAL),ge.bytes.writeVarUnsigned(n.index)):n.isPointer?(ge.bytes.emitUi32(n.offset),ge.bytes.emitLoad32()):n.isAlias?Ce(n.aliasValue):n.kind===he.Parameter?(ge.bytes.emitUi32(n.offset),ge.bytes.emitLoad32()):n.kind===he.FunctionDeclaration?ge.bytes.emitUi32(n.index):n.kind===he.VariableDeclaration?(ge.bytes.emitUi32(n.offset),ge.bytes.emitLoad32()):n.kind===he.Enumerator?(ge.bytes.emitU8(Be.OPCODE_I32_CONST),ge.bytes.emitLEB128(n.resolvedValue)):ge.__imports.error("Unknown identifier kind",e(n.kind))}function pe(e){let t=ge.scope.resolve(e.id);e.offset=ge.currentHeapOffset,t.isPointer?(ge.__imports.log("Store variable",e.id,"in memory at",t.offset),ge.bytes.emitUi32(t.offset),le(4),Me=!0,Ce(e.init),Me=!1,ge.bytes.emitStore32()):t.isAlias?(ge.__imports.log("Store alias",e.id,"in memory at",t.offset),ge.bytes.emitUi32(t.offset),le(4),Ce(e.aliasReference),ge.bytes.emitStore32()):(ge.__imports.log("Store variable",e.id,"in memory at",t.offset),ge.bytes.emitUi32(t.offset),le(4),Me=!0,Ce(e.init),Me=!1,ge.bytes.emitStore32())}function Se(e){e.offset=ge.currentHeapOffset,ge.__imports.log("Store parameter",e.value,"in memory at",e.offset),ge.bytes.emitUi32(e.offset),le(4),ge.bytes.emitU8(Be.OPCODE_GET_LOCAL),ge.bytes.writeVarUnsigned(e.index),ge.bytes.emitStore32()}function Ue(){let e=ge.scope,t=0;for(;null!==e&&(t++,e.node.kind!==he.WhileStatement);)e=e.parent;return t}function de(e){let t=e.operator;if("-"===t)ge.bytes.emitUi32(0),Ce(e.value),ge.bytes.emitU8(Be.OPCODE_I32_SUB);else if("+"===t)Ce(e.value);else if("!"===t)Ce(e.value),ge.bytes.emitU8(Be.OPCODE_I32_EQZ);else if("~"===t)ge.bytes.emitUi32(0),Ce(e.value),ge.bytes.emitU8(Be.OPCODE_I32_SUB),ge.bytes.emitUi32(1),ge.bytes.emitU8(Be.OPCODE_I32_SUB);else if("&"===t)De(e);else if("*"===t)Pe(e);else if("++"===t||"--"===t){let t="++"===e.operator?Be.OPCODE_I32_ADD:Be.OPCODE_I32_SUB;if("*"===e.value.operator)Ce(e.value.value);else{let t=ge.scope.resolve(e.value.value);ge.bytes.emitUi32(t.offset)}if(Ce(e.value),ge.bytes.emitUi32(1),ge.bytes.emitU8(t),ge.bytes.emitStore32(),"*"===e.value.operator)Ce(e.value.value);else{let t=ge.scope.resolve(e.value.value);ge.bytes.emitUi32(t.offset),ge.bytes.emitLoad32()}}}function be(e){let t=e.value;if("*"===t.operator)Ce(t.value);else{let e=ge.scope.resolve(t.value);ge.bytes.emitUi32(e.offset)}if(Ce(t),ge.bytes.emitUi32(1),"++"===e.operator?ge.bytes.emitU8(Be.OPCODE_I32_ADD):ge.bytes.emitU8(Be.OPCODE_I32_SUB),ge.bytes.emitStore32(),"*"===t.operator)Ce(t.value);else{let e=ge.scope.resolve(t.value);ge.bytes.emitUi32(e.offset),ge.bytes.emitLoad32()}ge.bytes.emitUi32(1),"--"===e.operator?ge.bytes.emitU8(Be.OPCODE_I32_ADD):ge.bytes.emitU8(Be.OPCODE_I32_SUB)}function Re(e){let t=ge.bytes.createU32vPatch(),n=e.locals,i=e.parameter;ge.bytes.writeVarUnsigned(n.length+i.length),n.map(e=>{ge.bytes.emitU8(1);ge.bytes.emitU8(te(e.type))}),i.map(e=>{ge.bytes.emitU8(1);ge.bytes.emitU8(te(e.type))}),i.map(e=>{Se(e)}),Ce(e.body),ge.bytes.emitU8(Be.OPCODE_END),t.patch(ge.bytes.length-t.offset)}function Te(e){return Array.from(e).map(e=>e.toString(16))}let Ne=0,he={},Le={},Ae={},Fe={};(e=>{e[e.Program=++Ne]="Program";e[e.BinaryExpression=++Ne]="BinaryExpression";e[e.UnaryExpression=++Ne]="UnaryExpression";e[e.UnaryPrefixExpression=++Ne]="UnaryPrefixExpression";e[e.UnaryPostfixExpression=++Ne]="UnaryPostfixExpression";e[e.CallExpression=++Ne]="CallExpression";e[e.CastExpression=++Ne]="CastExpression";e[e.ParameterExpression=++Ne]="ParameterExpression";e[e.BlockStatement=++Ne]="BlockStatement";e[e.ReturnStatement=++Ne]="ReturnStatement";e[e.IfStatement=++Ne]="IfStatement";e[e.ForStatement=++Ne]="ForStatement";e[e.WhileStatement=++Ne]="WhileStatement";e[e.ExpressionStatement=++Ne]="ExpressionStatement";e[e.ImportStatement=++Ne]="ImportStatement";e[e.ExportStatement=++Ne]="ExportStatement";e[e.BreakStatement=++Ne]="BreakStatement";e[e.ContinueStatement=++Ne]="ContinueStatement";e[e.FunctionExpression=++Ne]="FunctionExpression";e[e.FunctionDeclaration=++Ne]="FunctionDeclaration";e[e.VariableDeclaration=++Ne]="VariableDeclaration";e[e.EnumDeclaration=++Ne]="EnumDeclaration";e[e.Parameter=++Ne]="Parameter";e[e.Enumerator=++Ne]="Enumerator";e[e.Identifier=++Ne]="Identifier";e[e.Literal=++Ne]="Literal";e[e.Comment=++Ne]="Comment"})(he),(e=>{e[e.EOF=++Ne]="EOF";e[e.Unknown=++Ne]="Unknown";e[e.Keyword=++Ne]="Keyword";e[e.Identifier=++Ne]="Identifier";e[e.BooleanLiteral=++Ne]="BooleanLiteral";e[e.NullLiteral=++Ne]="NullLiteral";e[e.StringLiteral=++Ne]="StringLiteral";e[e.NumericLiteral=++Ne]="NumericLiteral";e[e.HexadecimalLiteral=++Ne]="HexadecimalLiteral"})(Le),(e=>{e[e["("]=++Ne]="LPAREN";e[e[")"]=++Ne]="RPAREN";e[e["{"]=++Ne]="LBRACE";e[e["}"]=++Ne]="RBRACE";e[e[","]=++Ne]="COMMA";e[e[";"]=++Ne]="SEMICOLON";e[e.true=++Ne]="TRUE";e[e.false=++Ne]="FALSE";e[e.enum=++Ne]="ENUM";e[e.import=++Ne]="IMPORT";e[e.extern=++Ne]="EXPORT";e[e.break=++Ne]="BREAK";e[e.continue=++Ne]="CONTINUE";e[e.do=++Ne]="DO";e[e.else=++Ne]="ELSE";e[e.for=++Ne]="FOR";e[e.if=++Ne]="IF";e[e.return=++Ne]="RETURN";e[e.while=++Ne]="WHILE";e[e.int=++Ne]="INT";e[e.i32=++Ne]="INT32";e[e.i64=++Ne]="INT64";e[e.float=++Ne]="FLOAT";e[e.f32=++Ne]="FLOAT32";e[e.f64=++Ne]="FLOAT64";e[e.void=++Ne]="VOID";e[e.bool=++Ne]="BOOLEAN"})(Ae),(e=>{e.LOWEST=++Ne;e.UNARY_POSTFIX=++Ne;e[e["="]=++Ne]="ASS";e[e["+="]=++Ne]="ADD_ASS";e[e["-="]=++Ne]="SUB_ASS";e[e["*="]=++Ne]="MUL_ASS";e[e["/="]=++Ne]="DIV_ASS";e[e["%="]=++Ne]="MOD_ASS";e[e["&="]=++Ne]="BIN_AND_ASS";e[e["|="]=++Ne]="BIN_OR_ASS";e[e["^="]=++Ne]="BIN_XOR_ASS";e[e["<<="]=++Ne]="BIN_SHL_ASS";e[e[">>="]=++Ne]="BIN_SHR_ASS";e[e["||"]=++Ne]="OR";e[e["&&"]=++Ne]="AND";e[e["=="]=++Ne]="EQ";e[e["!="]=++Ne]="NEQ";e[e["<"]=++Ne]="LT";e[e["<="]=++Ne]="LE";e[e[">"]=++Ne]="GT";e[e[">="]=++Ne]="GE";e[e["+"]=++Ne]="ADD";e[e["-"]=++Ne]="SUB";e[e["*"]=++Ne]="MUL";e[e["/"]=++Ne]="DIV";e[e["%"]=++Ne]="MOD";e[e["&"]=++Ne]="BIN_AND";e[e["|"]=++Ne]="BIN_OR";e[e["~"]=++Ne]="BIN_NOT";e[e["^"]=++Ne]="BIN_XOR";e[e["<<"]=++Ne]="BIN_SHL";e[e[">>"]=++Ne]="BIN_SHR";e[e["!"]=++Ne]="NOT";e[e["--"]=++Ne]="DECR";e[e["++"]=++Ne]="INCR";e.UNARY_PREFIX=++Ne;e.HIGHEST=++Ne})(Fe),(()=>{const e=[he,Le,Ae,Fe];e.map(e=>{for(let t in e){const n=parseInt(t);if(!(n>=0))continue;const i=e[t].toUpperCase();e[i]=n}})})();const Be={OPCODE_UNREACHABLE:0,OPCODE_NOP:1,OPCODE_BLOCK:2,OPCODE_LOOP:3,OPCODE_IF:4,OPCODE_ELSE:5,OPCODE_END:11,OPCODE_BR:12,OPCODE_BR_IF:13,OPCODE_BR_TABLE:14,OPCODE_RETURN:15,OPCODE_CALL:16,OPCODE_CALL_INDIRECT:17,OPCODE_DROP:26,OPCODE_SELECT:27,OPCODE_GET_LOCAL:32,OPCODE_SET_LOCAL:33,OPCODE_TEE_LOCAL:34,OPCODE_GET_GLOBAL:35,OPCODE_SET_GLOBAL:36,OPCODE_I32_LOAD:40,OPCODE_I64_LOAD:41,OPCODE_F32_LOAD:42,OPCODE_F64_LOAD:43,OPCODE_I32_LOAD8_S:44,OPCODE_I32_LOAD8_U:45,OPCODE_I32_LOAD16_S:46,OPCODE_I32_LOAD16_U:47,OPCODE_I64_LOAD8_S:48,OPCODE_I64_LOAD8_U:49,OPCODE_I64_LOAD16_S:50,OPCODE_I64_LOAD16_U:51,OPCODE_I64_LOAD32_S:52,OPCODE_I64_LOAD32_U:53,OPCODE_I32_STORE:54,OPCODE_I64_STORE:55,OPCODE_F32_STORE:56,OPCODE_F64_STORE:57,OPCODE_I32_STORE8:58,OPCODE_I32_STORE16:59,OPCODE_I64_STORE8:60,OPCODE_I64_STORE16:61,OPCODE_I64_STORE32:62,OPCODE_CURRENT_MEMORY:63,OPCODE_GROW_MEMORY:64,OPCODE_I32_CONST:65,OPCODE_I64_CONST:66,OPCODE_F32_CONST:67,OPCODE_F64_CONST:68,OPCODE_I32_EQZ:69,OPCODE_I32_EQ:70,OPCODE_I32_NEQ:71,OPCODE_I32_LT_S:72,OPCODE_I32_LT_U:73,OPCODE_I32_GT_S:74,OPCODE_I32_GT_U:75,OPCODE_I32_LE_S:76,OPCODE_I32_LE_U:77,OPCODE_I32_GE_S:78,OPCODE_I32_GE_U:79,OPCODE_I64_EQZ:80,OPCODE_I64_EQ:81,OPCODE_I64_NE:82,OPCODE_I64_LT_S:83,OPCODE_I64_LT_U:84,OPCODE_I64_GT_S:85,OPCODE_I64_GT_U:86,OPCODE_I64_LE_S:87,OPCODE_I64_LE_U:88,OPCODE_I64_GE_S:89,OPCODE_I64_GE_U:90,OPCODE_F32_EQ:91,OPCODE_F32_NE:92,OPCODE_F32_LT:93,OPCODE_F32_GT:94,OPCODE_F32_LE:95,OPCODE_F32_GE:96,OPCODE_F64_EQ:97,OPCODE_F64_NE:98,OPCODE_F64_LT:99,OPCODE_F64_GT:100,OPCODE_F64_LE:101,OPCODE_F64_GE:102,OPCODE_I32_CLZ:103,OPCODE_I32_CTZ:104,OPCODE_I32_POPCNT:105,OPCODE_I32_ADD:106,OPCODE_I32_SUB:107,OPCODE_I32_MUL:108,OPCODE_I32_DIV_S:109,OPCODE_I32_DIV_U:110,OPCODE_I32_REM_S:111,OPCODE_I32_REM_U:112,OPCODE_I32_AND:113,OPCODE_I32_OR:114,OPCODE_I32_XOR:115,OPCODE_I32_SHL:116,OPCODE_I32_SHR_S:117,OPCODE_I32_SHR_U:118,OPCODE_I32_ROTL:119,OPCODE_I32_ROTR:120,OPCODE_I64_CLZ:121,OPCODE_I64_CTZ:122,OPCODE_I64_POPCNT:123,OPCODE_I64_ADD:124,OPCODE_I64_SUB:125,OPCODE_I64_MUL:126,OPCODE_I64_DIV_S:127,OPCODE_I64_DIV_U:128,OPCODE_I64_REM_S:129,OPCODE_I64_REM_U:130,OPCODE_I64_AND:131,OPCODE_I64_OR:132,OPCODE_I64_XOR:133,OPCODE_I64_SHL:134,OPCODE_I64_SHR_S:135,OPCODE_I64_SHR_U:136,OPCODE_I64_ROTL:137,OPCODE_I64_ROTR:138,OPCODE_F32_ABS:139,OPCODE_F32_NEG:140,OPCODE_F32_CEIL:141,OPCODE_F32_FLOOR:142,OPCODE_F32_TRUNC:143,OPCODE_F32_NEAREST:144,OPCODE_F32_SQRT:145,OPCODE_F32_ADD:146,OPCODE_F32_SUB:147,OPCODE_F32_MUL:148,OPCODE_F32_DIV:149,OPCODE_F32_MIN:150,OPCODE_F32_MAX:151,OPCODE_F32_COPYSIGN:152,OPCODE_F64_ABS:153,OPCODE_F64_NEG:154,OPCODE_F64_CEIL:155,OPCODE_F64_FLOOR:156,OPCODE_F64_TRUNC:157,OPCODE_F64_NEAREST:158,OPCODE_F64_SQRT:159,OPCODE_F64_ADD:160,OPCODE_F64_SUB:161,OPCODE_F64_MUL:162,OPCODE_F64_DIV:163,OPCODE_F64_MIN:164,OPCODE_F64_MAX:165,OPCODE_F64_COPYSIGN:166,OPCODE_I32_WRAP_I64:167,OPCODE_I32_TRUNC_S_F32:168,OPCODE_I32_TRUNC_U_F32:169,OPCODE_I32_TRUNC_S_F64:170,OPCODE_I32_TRUNC_U_F64:171,OPCODE_I64_EXTEND_S_I32:172,OPCODE_I64_EXTEND_U_I32:173,OPCODE_I64_TRUNC_S_F32:174,OPCODE_I64_TRUNC_U_F32:175,OPCODE_I64_TRUNC_S_F64:176,OPCODE_I64_TRUNC_U_F64:177,OPCODE_F32_CONVERT_S_I32:178,OPCODE_F32_CONVERT_U_I32:179,OPCODE_F32_CONVERT_S_I64:180,OPCODE_F32_CONVERT_U_I64:181,OPCODE_F32_DEMOTE_F64:182,OPCODE_F64_CONVERT_S_I32:183,OPCODE_F64_CONVERT_U_I32:184,OPCODE_F64_CONVERT_S_I64:185,OPCODE_F64_CONVERT_U_I64:186,OPCODE_F64_PROMOTE_F32:187,OPCODE_I32_REINTERPRET_F32:188,OPCODE_I64_REINTERPRET_F64:189,OPCODE_F32_REINTERPRET_I32:190,OPCODE_F64_REINTERPRET_I64:191,MAGIC:1836278016,VERSION:1,INITIAL_MEMORY:256,MAXIMUM_MEMORY:256,SECTION_TYPE:1,SECTION_FUNCTION:3,SECTION_TABLE:4,SECTION_MEMORY:5,SECTION_GLOBAL:6,SECTION_EXPORT:7,SECTION_ELEMENT:9,SECTION_CODE:10,TYPE_VOID:0,TYPE_I32:127,TYPE_I64:126,TYPE_F32:125,TYPE_F64:124,TYPE_CTOR_VOID:0,TYPE_CTOR_I32:127,TYPE_CTOR_I64:126,TYPE_CTOR_F32:125,TYPE_CTOR_F64:124,TYPE_CTOR_FUNC:96,TYPE_CTOR_ANYFUNC:112,TYPE_CTOR_BLOCK:64,EXTERN_FUNCTION:0,EXTERN_TABLE:1,EXTERN_MEMORY:2,EXTERN_GLOBAL:3,EXTERN_FUNC:3};class ke extends Array{emitU8(e){this.push(255&e)}emitU16(e){this.push(255&e),this.push(e>>8&255)}emitU32(e){this.push(255&e),this.push(e>>8&255),this.push(e>>16&255),this.push(e>>24&255)}emitU32v(e){for(;;){let t=255&e;if(0==(e>>>=7)){this.push(t);break}this.push(128|t)}}emit32v(e){for(;;){var t=127&e,n=0===(e>>=7)&&0==(64&t)||-1===e&&0!=(64&t);if(n||(t|=128),this.push(255&t),n)break}}emitULEB128(e){let t=0;do{t=127&e,(e>>>=7)&&(t|=128),this.push(t)}while(e)}emitLEB128(e){let t=0;for(;;){let n=0!=(64&(t=127&e));if(0===(e>>>=7)&&!n||-1===e&&n){this.push(t);break}t|=128,this.push(t)}}patchLEB128(e,t){let n=0,i=0;for(;;){let r=0!=(64&(n=127&e));if(0===(e>>>=7)&&!r||-1===e&&r){this[t+i]=n;break}n|=128,this[t+i]=n,i++}}patchULEB128(e,t){let n=0,i=0;do{n=127&e,(e>>>=7)&&(n|=128),this[t+i]=n,i++}while(e)}createU32vPatch(){this.writeVarUnsigned(-1);let e=this.length;return{offset:e,patch:t=>{this.patchU32v(t,e-5)}}}patchU32v(e,t){for(var n=e>>>0,i=-1>>>0;;){var r=127&n;if(n>>>=7,0!==(i>>>=7)&&(r|=128),this[t]=255&r,t++,0===i)break}}writeVarUnsigned(e){for(var t=e>>>0;;){var n=127&t;if(0!==(t>>>=7)&&(n|=128),this.push(255&n),0===t)break}}createLEB128Patch(){let e=this.length;return this.emitU8(0),{offset:e,patch:t=>this.patchLEB128(t,e)}}createULEB128Patch(){let e=this.length;return this.emitU8(0),{offset:e,patch:t=>this.patchULEB128(t,e)}}emitUi32(e){e|=0,this.emitU8(Be.OPCODE_I32_CONST),this.writeVarUnsigned(e)}emitLoad32(){this.emitU8(Be.OPCODE_I32_LOAD),this.emitU8(2),this.writeVarUnsigned(0)}emitStore32(){this.emitU8(Be.OPCODE_I32_STORE),this.emitU8(2),this.writeVarUnsigned(0)}emitString(e){var t=0|e.length;this.emitU32v(t);this.length;for(var n=0;n<t;)this.push(255&e.charCodeAt(n)),n++}}class ve{constructor(e=null){this.reset(e)}reset(e){this.bytes=new ke,this.scope=null,this._global=null,this.pindex=0,this.tokens=null,this.current=null,this.__imports=e,this.currentHeapOffset=null}}var ge=new ve;const xe=!1;let Me=!1;return function(e,t={log:console.log},n){ge.reset(t);let i=f(ee(e));ie(i);let r=new Uint8Array(ge.bytes),_=Te(r);if(!0===n){let e=new WebAssembly.Module(r),t=new WebAssembly.Instance(e);return{ast:i,dump:_,buffer:r,memory:t.exports.memory,instance:t,exports:t.exports}}return new Promise((e,t)=>{WebAssembly.instantiate(r).then(t=>{let n=t.instance;e({ast:i,dump:_,buffer:r,memory:n.exports.memory,instance:n,exports:n.exports})})})}});
