!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.momo=t()}(this,function(){"use strict";function e(e){return e|=0,void 0!==Te[e]?Te[e]:void 0!==Se[e]?Se[e]:void 0!==Re[e]?Re[e]:void 0!==he[e]?he[e]:"undefined"}function t(){this.node=null,this.index=0,this.parent=null,this.symbols={},this.localIndex=0,this.resolve=function(e){return this.symbols[e]?this.symbols[e]:this.parent?this.parent.resolve(e):(Fe.__imports.error(e+" is not defined"),null)},this.register=function(e,t){if(t.kind!==Te.FunctionDeclaration){if(void 0!==this.symbols[e]&&Fe.__imports.error("Symbol "+e+" is already defined"),this.symbols[e]=t,null!==this.parent&&(t.kind===Te.VariableDeclaration||t.kind===Te.Parameter)){let e=n(this);t.index=e.localIndex++}}else this.registerFunction(e,t)},this.registerFunction=function(e,t){let n=this.symbols[e]||null;n&&(n.type!==t.type&&Fe.__imports.error(`Conflicting types for '${e}'`),n.isPrototype||t.isPrototype||Fe.__imports.error(`Redefinition of '${e}'`)),this.symbols[e]=t}}function n(e){let t=e;for(;null!==t&&t.node.kind!==Te.FunctionDeclaration;)t=t.parent;return t}function i(e){let n=new t;n.node=e,n.parent=Fe.scope,n.index=Fe.scope?Fe.scope.index+1:0,e.context=n,Fe.scope=n}function r(){null!==Fe.scope&&(Fe.scope=Fe.scope.parent)}function O(e,t){let n=Fe.scope;for(;null!==n&&(!n||n.node.kind!==t);)n=n.parent;null===n&&null!==t&&Fe.__imports.error("Invalid scope of node "+e.kind+", expected",t)}function _(e){let t=e.kind;return(t===he.ASS||t===he.ADD||t===he.SUB||t===he.MUL||t===he.DIV||t===he.MOD||t===he.OR||t===he.AND||t===he.BIN_AND||t===he.BIN_OR||t===he.NOT||t===he.LT||t===he.LE||t===he.GT||t===he.GE||t===he.EQ||t===he.NEQ||t===he.ADD_ASS||t===he.SUB_ASS||t===he.MUL_ASS||t===he.DIV_ASS||t===he.MOD_ASS)&&t!==he.NOT&&t!==he.INCR&&t!==he.DECR}function s(e){return e===he.ASS||e===he.ADD_ASS||e===he.SUB_ASS||e===he.MUL_ASS||e===he.DIV_ASS||e===he.MOD_ASS}function o(e){let t=e.kind;return t===he.BIN_AND||t===he.MUL||t===he.SUB||t===he.ADD||t===he.NOT||t===he.INCR||t===he.DECR}function E(e){let t=e.kind;return t===he.INCR||t===he.DECR}function a(e){let t=e.kind;return t===Se.NumericLiteral||t===Se.HexadecimalLiteral||t===Se.BooleanLiteral||t===Se.Identifier}function u(e){let t=e.kind;return t===Re.INT||t===Re.INT32||t===Re.INT64||t===Re.FLOAT||t===Re.FLOAT32||t===Re.FLOAT64||t===Re.VOID||t===Re.BOOLEAN}function c(e){Fe.tokens=e,Fe.pindex=-1,l();let t={kind:Te.Program,body:null};return i(t),Fe.global=Fe.scope,t.body=m(),t}function C(e){return Fe.current&&Fe.current.kind===e}function l(){Fe.pindex++,Fe.current=Fe.tokens[Fe.pindex]}function D(e){const{current:t,__imports:n}=Fe;t.kind!==e?n.error("Expected "+e+" but got "+t.kind+" in "+t.line+":"+t.column):l()}function P(){const{current:e,__imports:t}=Fe;e.kind!==Se.IDENTIFIER&&t.error("Expected "+Se.IDENTIFIER+":identifier but got "+e.kind+":"+e.value)}function f(e){return!!C(e)&&(l(),!0)}function m(){let e={kind:Te.BlockStatement,body:[],context:Fe.scope};for(;;){if(!Fe.current)break;if(C(Re.RBRACE))break;let t=I();if(null===t)break;e.body.push(t)}return e}function I(){const{current:e,__imports:t}=Fe;let n=null;return f(Re.EXPORT)?n=y(!0):u(e)?n=y(!1):C(Re.RETURN)?n=d():C(Re.IF)?n=b():C(Re.WHILE)?n=U():null===(n=Y(he.LOWEST))&&t.error("Unknown node kind "+e.value+" in "+e.line+":"+e.column),f(Re.SEMICOLON),n}function y(e){let t=null;g();const n=Fe.current.kind;l();let i=f(he.MUL),r=!1;i||(r=f(he.BIN_AND)),P();const O=Fe.current.value;return l(),Fe.current.kind===he.ASS?t=h(n,O,e,i,r):Re.LPAREN?t=T(n,O,e):(t=null,Fe.__imports.error("Invalid keyword: "+Fe.current.value)),t}function U(){let e={kind:Te.WhileStatement,condition:null,body:null};return D(Re.WHILE),e.condition=Y(he.LOWEST),f(Re.LBRACE)?(i(e),e.body=m(),r(),D(Re.RBRACE)):e.body=Y(he.LOWEST),e}function b(){let e={kind:Te.IfStatement,condition:null,alternate:null,consequent:null};return f(Re.IF)?(D(Re.LPAREN),e.condition=Y(he.LOWEST),D(Re.RPAREN),i(e),e.consequent=p(),r(),f(Re.ELSE)&&(e.alternate=b()),e):(i(e),e.consequent=p(),r(),e)}function p(){let e=null;return f(Re.LBRACE)?(e=m(),D(Re.RBRACE)):((e=[]).push(Y(he.LOWEST)),f(Re.SEMICOLON)),e}function d(){D(Re.RETURN);let e={kind:Te.ReturnStatement,argument:Y(he.LOWEST)};O(e,Te.FunctionDeclaration);let t=Fe.scope;for(;null!==t&&(!t||t.node.kind!==Te.FunctionDeclaration);)t=t.parent;return t.node.returns.push(e),e}function T(e,t,n){let _={index:0,isExported:!!n,kind:Te.FunctionDeclaration,type:e,id:t,locals:[],returns:[],parameter:null,prototype:null,body:null};return O(_,null),_.parameter=S(_),_.isPrototype=!f(Re.LBRACE),Fe.scope.register(t,_),_.isPrototype||(i(_),_.parameter.map(e=>{Fe.scope.register(e.value,e)}),_.body=m(),r(),D(Re.RBRACE)),null===_.prototype||_.type===Re.VOID||_.returns.length||Fe.__imports.error("Missing return in function: "+_.id),_}function S(e){let t=[];e.prototype;for(D(Re.LPAREN);;){if(C(Re.RPAREN))break;let n=R(e);if(t.push(n),!f(Re.COMMA))break}return D(Re.RPAREN),t}function R(e){let t=null;u(Fe.current)?(t=Fe.current.kind,l()):Fe.__imports.error("Missing type for parameter in",e.id);let n=f(he.MUL),i=!1;n||(i=f(he.BIN_AND)),P();let r=Fe.current;return r.type=t,r.kind=Te.Parameter,r.isParameter=!0,r.isPointer=n,r.isReference=i,l(),r}function h(e,t,i,r,_){let s={kind:Te.VariableDeclaration,type:e,id:t,init:null,isGlobal:!1,isPointer:r,isAlias:_};i&&O(s,null),Fe.scope.register(s.id,s),null===Fe.scope.parent&&(s.isGlobal=!0),D(he.ASS);let o=Y(he.LOWEST);if(s.init={kind:Te.BinaryExpression,left:{kind:Te.Literal,type:Se.Identifier,value:s.id},right:o,operator:"="},_&&(s.aliasValue=o,s.aliasReference={kind:Te.UnaryPrefixExpression,operator:"&",value:s.aliasValue}),!s.isGlobal){let e=n(Fe.scope).node;e.locals.push(s)}return s}function L(e){return{kind:Te.CallExpression,callee:e,parameter:N(e.value)}}function N(e){let t=[];Fe.scope.resolve(e);D(Re.LPAREN);let n=0;for(;;){if(C(Re.RPAREN))break;let e=Y(he.LOWEST);if(t.push(e),!f(Re.COMMA))break;n++}return D(Re.RPAREN),t}function A(){let e={kind:Te.BreakStatement};return D(Re.BREAK),O(e,Te.WhileStatement),e}function F(){let e={kind:Te.ContinueStatement};return D(Re.CONTINUE),O(e,Te.WhileStatement),e}function k(e){return e.kind===he.CAST}function x(e){let t={kind:Te.CastExpression,source:e,target:null};return l(),g(),t.target=Fe.current,l(),t}function g(){u(Fe.current)||Fe.__imports.error("Expected type literal but got "+Fe.current.kind)}function B(){let e={kind:Te.UnaryPrefixExpression,operator:Fe.current.value,value:null};return l(),e.value=Y(he.UNARY_PREFIX),e}function v(e){let t={kind:Te.UnaryPostfixExpression,operator:Fe.current.value,value:e};return l(),t}function M(){if(a(Fe.current))return w();if(f(Re.LPAREN)){let e=Y(he.LOWEST);return D(Re.RPAREN),e}return o(Fe.current)?B():Y(he.LOWEST)}function V(e,t){let n=Fe.current.value,i=he[n];if(e>i)return t;let r={kind:Te.BinaryExpression,left:t,right:null,operator:n};l(),r.right=Y(i);let O=he[n];if(s(O)&&O!==he.ASS){let e={kind:Te.BinaryExpression,left:r.left,operator:"=",right:{kind:Te.BinaryExpression,operator:n.charAt(0),left:r.left,right:r.right}};r=e}return r}function G(e,t){return _(Fe.current)?V(e,t):E(Fe.current)?e>=he.UNARY_POSTFIX?t:v(t):C(Re.LPAREN)?L(t):k(Fe.current)?x(t):t}function Y(e){if(C(Re.BREAK))return A();if(C(Re.CONTINUE))return F();let t=M();for(;;){if(!Fe.current)break;let n=G(e,t);if(null===n||n===t)break;t=n}return t}function w(){let e=Fe.current.value;Fe.current.kind===Se.IDENTIFIER&&Fe.scope.resolve(e);let t={kind:Te.Literal,type:Fe.current.kind,value:e};return l(),t}function W(e){return 9===e||11===e||12===e||32===e||160===e}function H(e){return e>=65&&e<=90||e>=97&&e<=122||95===e}function X(e){return e>=48&&e<=57}function Q(e){return X(e)||e>=97&&e<=102}function K(e){return"("===e||")"===e||"{"===e||"}"===e||","===e||";"===e}function Z(e){return"="===e||"+"===e||"-"===e||"!"===e||"|"===e||"&"===e||">"===e||"<"===e||"*"===e||"/"===e}function q(e){return 1===e.length?Z(e):"++"===e||"--"===e||"=="===e||"!="===e||"||"===e||"&&"===e||">="===e||"<="===e||"+="===e||"-="===e||"*="===e||"/="===e||"%="===e||"=>"===e}function j(e,t,n,i){let r=Se.UNKNOWN,O=z(r=Re[t]>=0?Re[t]:he[t]>=0?he[t]:Se.Identifier,t,n,i-t.length);return e.push(O),O}function z(e,t,n,i){return{kind:e,value:t,line:n,column:i}}function J(e){function t(){n++,r++}let n=-1,i=1,r=0,O=e.length,_=[];for(;;){t();let s=e.charAt(n),o=e.charCodeAt(n);if(!W(o))if(10!==o)if(H(o)){let O=n;for(;;){if(!H(o)&&!X(o)){n--,r--;break}t(),o=e.charCodeAt(n)}let s=e.slice(O,n+1);j(_,s,i,r)}else if(X(o)){if("x"===e.charAt(n+1)){let O=n;for(t();;){if(!Q(o)){n--,r--;break}t(),o=e.charCodeAt(n)}let s=e.slice(O,n+1),E=z(Se.HexadecimalLiteral,s,i,r);_.push(E);continue}let O=n;for(;;){if(!X(o)&&45!==o){n--,r--;break}t(),o=e.charCodeAt(n)}let s=e.slice(O,n+1),E=z(Se.NumericLiteral,s,i,r);_.push(E)}else if("/"!==s||"/"!==e[n+1]){if(K(s)){let t=e.slice(n,n+1);j(_,t,i,r)}else if(Z(s)){let O=e.slice(n+1,n+2);!function(e,n,i,r){n&&q(e+n)?(t(),j(_,e+n,i,r)):q(e)&&j(_,e,i,r)}(s,O,i,r)}else if(n>=O)break}else for(;;){if(10===o){r=0,i++;break}t(),o=e.charCodeAt(n)}else i++,r=0}return _}function $(e){switch(e){case Re.VOID:return Le.TYPE_CTOR_VOID;case Re.INT:case Re.INT32:return Le.TYPE_CTOR_I32;case Re.INT64:return Le.TYPE_CTOR_I64;case Re.FLOAT:case Re.FLOAT32:return Le.TYPE_CTOR_I32;case Re.FLOAT64:return Le.TYPE_CTOR_F64;case Re.BOOL:return Le.TYPE_CTOR_I32}return-1}function ee(e){switch(e){case"+":return Le.OPCODE_I32_ADD;case"-":return Le.OPCODE_I32_SUB;case"*":return Le.OPCODE_I32_MUL;case"/":return Le.OPCODE_I32_DIV_S;case"%":return Le.OPCODE_I32_REM_S;case"<":return Le.OPCODE_I32_LT_S;case"<=":return Le.OPCODE_I32_LE_S;case">":return Le.OPCODE_I32_GT_S;case">=":return Le.OPCODE_I32_GE_S;case"==":return Le.OPCODE_I32_EQ;case"!=":return Le.OPCODE_I32_NEQ;case"&&":return Le.OPCODE_I32_AND;case"||":return Le.OPCODE_I32_OR}return-1}function te(e){Fe.scope=e.context,Fe.bytes.emitU32(Le.MAGIC),Fe.bytes.emitU32(Le.VERSION),_e(e.body),se(e.body),ie(e.body),oe(e),Oe(e.body),Ee(e.body),ne(e.body),ae(e.body)}function ne(e){Fe.bytes.emitU8(Le.SECTION_ELEMENT);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==Te.FunctionDeclaration||e.isPrototype||(Fe.bytes.writeVarUnsigned(0),Fe.bytes.emitUi32(e.index),Fe.bytes.emitU8(Le.OPCODE_END),Fe.bytes.writeVarUnsigned(1),Fe.bytes.writeVarUnsigned(e.index),i++)}),n.patch(i),t.patch(Fe.bytes.length-t.offset)}function ie(e){Fe.bytes.emitU8(Le.SECTION_TABLE);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch();re(e),n.patch(1),t.patch(Fe.bytes.length-t.offset)}function re(e){Fe.bytes.emitU8(Le.TYPE_CTOR_ANYFUNC),Fe.bytes.emitU8(1);let t=0;e.body.map(e=>{e.kind!==Te.FunctionDeclaration||e.isPrototype||t++}),Fe.bytes.writeVarUnsigned(t),Fe.bytes.writeVarUnsigned(t)}function Oe(e){Fe.bytes.emitU8(Le.SECTION_GLOBAL);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch(),i=0;e.body.map(e=>{if(e.kind===Te.VariableDeclaration&&e.isGlobal){let t=e.init.right;e.index=i++,Fe.bytes.emitU8($(e.type)),Fe.bytes.emitU8(1),ce(t),Fe.bytes.emitU8(Le.OPCODE_END)}}),n.patch(i),t.patch(Fe.bytes.length-t.offset)}function _e(e){Fe.bytes.emitU8(Le.SECTION_TYPE);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==Te.FunctionDeclaration||e.isPrototype||(Fe.bytes.emitU8(Le.TYPE_CTOR_FUNC),Fe.bytes.writeVarUnsigned(e.parameter.length),e.parameter.map(e=>{Fe.bytes.emitU8($(e.type))}),e.type!==Re.VOID?(Fe.bytes.emitU8(1),Fe.bytes.emitU8($(e.type))):Fe.bytes.emitU8(0),e.index=i,i++)}),n.patch(i),t.patch(Fe.bytes.length-t.offset)}function se(e){Fe.bytes.emitU8(Le.SECTION_FUNCTION);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==Te.FunctionDeclaration||e.isPrototype||(i++,Fe.bytes.writeVarUnsigned(e.index))}),n.patch(i),t.patch(Fe.bytes.length-t.offset)}function oe(e){Fe.bytes.emitU8(Le.SECTION_MEMORY);let t=Fe.bytes.createU32vPatch();Fe.bytes.emitU32v(1),Fe.bytes.emitU32v(0),Fe.bytes.emitU32v(1),t.patch(Fe.bytes.length-t.offset)}function Ee(e){Fe.bytes.emitU8(Le.SECTION_EXPORT);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==Te.FunctionDeclaration||e.isPrototype||(e.isExported||"main"===e.id)&&(i++,Fe.bytes.emitString(e.id),Fe.bytes.emitU8(Le.EXTERN_FUNCTION),Fe.bytes.writeVarUnsigned(e.index))}),(()=>{i++;Fe.bytes.emitString("memory");Fe.bytes.emitU8(Le.EXTERN_MEMORY);Fe.bytes.emitU8(0)})(),n.patch(i),t.patch(Fe.bytes.length-t.offset)}function ae(e){Fe.bytes.emitU8(Le.SECTION_CODE);let t=Fe.bytes.createU32vPatch(),n=Fe.bytes.createU32vPatch(),i=0;e.body.map(e=>{e.kind!==Te.FunctionDeclaration||e.isPrototype||(be(e),i++)}),n.patch(i),t.patch(Fe.bytes.length-t.offset)}function ue(e){Fe.currentHeapOffset+=e}function ce(e){let t=e.kind;if(t===Te.BlockStatement){let t=e.context.node,n=t.kind===Te.IfStatement||t.kind===Te.WhileStatement||t.kind===Te.FunctionDeclaration;e.context&&(Fe.scope=e.context),n||(Fe.bytes.emitU8(Le.OPCODE_BLOCK),Fe.bytes.emitU8(Le.TYPE_CTOR_BLOCK)),e.body.map(e=>{ce(e)}),n||Fe.bytes.emitU8(Le.OPCODE_END),e.context&&(Fe.scope=Fe.scope.parent)}else if(t===Te.IfStatement)e.condition&&(ce(e.condition),Fe.bytes.emitU8(Le.OPCODE_IF),Fe.bytes.emitU8(Le.TYPE_CTOR_BLOCK)),ce(e.consequent),e.alternate&&(Fe.bytes.emitU8(Le.OPCODE_ELSE),ce(e.alternate)),e.condition&&Fe.bytes.emitU8(Le.OPCODE_END);else if(t===Te.ReturnStatement)e.argument&&ce(e.argument),Fe.bytes.emitU8(Le.OPCODE_RETURN);else if(t===Te.CallExpression){let t=e.callee.value,n=Fe.scope.resolve(t);e.parameter.map(e=>{ce(e)}),n.isPointer?(Fe.bytes.emitUi32(n.offset),Fe.bytes.emitLoad32(),Fe.bytes.emitU8(Le.OPCODE_CALL_INDIRECT),Fe.bytes.writeVarUnsigned(n.offset),Fe.bytes.emitU8(0)):(Fe.bytes.emitU8(Le.OPCODE_CALL),Fe.bytes.writeVarUnsigned(n.index))}else if(t===Te.VariableDeclaration)Ie(e);else if(t===Te.WhileStatement)Fe.bytes.emitU8(Le.OPCODE_BLOCK),Fe.bytes.emitU8(Le.TYPE_CTOR_BLOCK),Fe.bytes.emitU8(Le.OPCODE_LOOP),Fe.bytes.emitU8(Le.TYPE_CTOR_BLOCK),ce(e.condition),Fe.bytes.emitU8(Le.OPCODE_I32_EQZ),Fe.bytes.emitU8(Le.OPCODE_BR_IF),Fe.bytes.emitU8(1),ce(e.body),Fe.bytes.emitU8(Le.OPCODE_BR),Fe.bytes.emitU8(0),Fe.bytes.emitU8(Le.OPCODE_UNREACHABLE),Fe.bytes.emitU8(Le.OPCODE_END),Fe.bytes.emitU8(Le.OPCODE_END);else if(t===Te.BreakStatement){Fe.bytes.emitU8(Le.OPCODE_BR);let e=ye();Fe.bytes.writeVarUnsigned(e),Fe.bytes.emitU8(Le.OPCODE_UNREACHABLE)}else if(t===Te.ContinueStatement){Fe.bytes.emitU8(Le.OPCODE_BR);let e=ye();Fe.bytes.writeVarUnsigned(e-1),Fe.bytes.emitU8(Le.OPCODE_UNREACHABLE)}else if(t===Te.Literal)e.type===Se.Identifier?me(e):e.type===Se.NumericLiteral||e.type===Se.HexadecimalLiteral?(Fe.bytes.emitU8(Le.OPCODE_I32_CONST),Fe.bytes.emitLEB128(parseInt(e.value))):Fe.__imports.error("Unknown literal type "+e.type);else if(t===Te.UnaryPrefixExpression){let t=e.operator;if("-"===t)Fe.bytes.emitUi32(0),ce(e.value),Fe.bytes.emitU8(Le.OPCODE_I32_SUB);else if("+"===t)ce(e.value);else if("!"===t)ce(e.value),Fe.bytes.emitU8(Le.OPCODE_I32_EQZ);else if("++"===t||"--"===t){let t=e.value,n=Fe.scope.resolve(t.value),i="++"===e.operator?Le.OPCODE_I32_ADD:Le.OPCODE_I32_SUB;Fe.bytes.emitUi32(n.offset),ce(t),Fe.bytes.emitUi32(1),Fe.bytes.emitU8(i),Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0),Fe.bytes.emitUi32(n.offset),Fe.bytes.emitLoad32()}else"&"===t?le(e):"*"===t&&De(e)}else if(t===Te.UnaryPostfixExpression)Ue(e);else if(t===Te.BinaryExpression){let t=e.operator;"="===t?fe(e):(ce(e.left),ce(e.right),Fe.bytes.emitU8(ee(t)))}else Fe.__imports.error("Unknown node kind "+t)}function Ce(e){return e.kind===Te.UnaryPrefixExpression?Ce(e.value):e}function le(t){let n=Ce(t),i=Fe.scope.resolve(n.value);if(i.isPointer){let r=t.value;r.type===Se.Identifier?Fe.bytes.emitUi32(i.offset):"*"===r.operator?ce(n):Fe.__imports.log("Unsupported adress-of value",e(r.kind))}else i.kind===Te.FunctionDeclaration?Fe.bytes.emitUi32(i.index):i.isAlias?ce(i.aliasReference):Fe.bytes.emitUi32(i.offset)}function De(e){ce(e.value),Fe.bytes.emitLoad32()}function Pe(e){ce(e.left.value),ce(e.right),Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0)}function fe(e){e.left;if("*"===e.left.operator)return void Pe(e);let t=Fe.scope.resolve(e.left.value);"="===e.right.operator?(ce(e.right),ce(e.right.left)):t.isGlobal?(ce(e.right),Fe.bytes.emitU8(Le.OPCODE_SET_GLOBAL),Fe.bytes.writeVarUnsigned(t.index)):t.isAlias?ce({kind:Te.BinaryExpression,operator:"=",left:t.aliasValue,right:e.right}):t.isParameter&&!t.isPointer?(ce(e.right),Fe.bytes.emitU8(Le.OPCODE_SET_LOCAL),Fe.bytes.writeVarUnsigned(t.index)):ke?ce(e.right):(Fe.bytes.emitUi32(t.offset),ce(e.right),Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.writeVarUnsigned(0))}function me(t){let n=Fe.scope.resolve(t.value);n.isGlobal?(Fe.bytes.emitU8(Le.OPCODE_GET_GLOBAL),Fe.bytes.writeVarUnsigned(n.index)):n.isParameter?(Fe.bytes.emitU8(Le.OPCODE_GET_LOCAL),Fe.bytes.writeVarUnsigned(n.index)):n.isPointer?(Fe.bytes.emitUi32(n.offset),Fe.bytes.emitLoad32()):n.isAlias?ce(n.aliasValue):n.kind===Te.FunctionDeclaration?Fe.bytes.emitUi32(n.index):n.kind===Te.VariableDeclaration?(Fe.bytes.emitUi32(n.offset),Fe.bytes.emitLoad32()):Fe.__imports.error("Unknown identifier kind",e(n.kind))}function Ie(e){let t=Fe.scope.resolve(e.id);e.offset=Fe.currentHeapOffset,t.isPointer?(Fe.__imports.log("Store variable",e.id,"in memory at",t.offset),Fe.bytes.emitUi32(t.offset),ue(4),ke=!0,ce(e.init),ke=!1,Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0)):t.isAlias?(Fe.__imports.log("Store alias",e.id,"in memory at",t.offset),Fe.bytes.emitUi32(t.offset),ue(4),ce(e.aliasReference),Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0)):(Fe.__imports.log("Store variable",e.id,"in memory at",t.offset),Fe.bytes.emitUi32(t.offset),ue(4),ke=!0,ce(e.init),ke=!1,Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0))}function ye(){let e=Fe.scope,t=0;for(;null!==e&&(t++,e.node.kind!==Te.WhileStatement);)e=e.parent;return t}function Ue(e){let t=e.value,n=Fe.scope.resolve(t.value);"++"===e.operator?(Fe.bytes.emitUi32(n.offset),Fe.bytes.emitUi32(1),me(t),Fe.bytes.emitU8(Le.OPCODE_I32_ADD),Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0),Fe.bytes.emitUi32(n.offset),Fe.bytes.emitLoad32(),Fe.bytes.emitUi32(1),Fe.bytes.emitU8(Le.OPCODE_I32_SUB)):"--"===e.operator&&(Fe.bytes.emitUi32(n.offset),me(t),Fe.bytes.emitUi32(1),Fe.bytes.emitU8(Le.OPCODE_I32_SUB),Fe.bytes.emitU8(Le.OPCODE_I32_STORE),Fe.bytes.emitU8(2),Fe.bytes.emitU8(0),Fe.bytes.emitUi32(n.offset),Fe.bytes.emitLoad32(),Fe.bytes.emitUi32(1),Fe.bytes.emitU8(Le.OPCODE_I32_ADD))}function be(e){let t=Fe.bytes.createU32vPatch(),n=e.locals;Fe.bytes.writeVarUnsigned(n.length),n.map(e=>{Fe.bytes.emitU8(1);Fe.bytes.emitU8($(e.type))}),ce(e.body),Fe.bytes.emitU8(Le.OPCODE_END),t.patch(Fe.bytes.length-t.offset)}function pe(e){return Array.from(e).map(e=>e.toString(16))}let de=0,Te={},Se={},Re={},he={};(e=>{e[e.Program=++de]="Program";e[e.BinaryExpression=++de]="BinaryExpression";e[e.UnaryExpression=++de]="UnaryExpression";e[e.UnaryPrefixExpression=++de]="UnaryPrefixExpression";e[e.UnaryPostfixExpression=++de]="UnaryPostfixExpression";e[e.CallExpression=++de]="CallExpression";e[e.CastExpression=++de]="CastExpression";e[e.ParameterExpression=++de]="ParameterExpression";e[e.BlockStatement=++de]="BlockStatement";e[e.ReturnStatement=++de]="ReturnStatement";e[e.IfStatement=++de]="IfStatement";e[e.ForStatement=++de]="ForStatement";e[e.WhileStatement=++de]="WhileStatement";e[e.ExpressionStatement=++de]="ExpressionStatement";e[e.ImportStatement=++de]="ImportStatement";e[e.ExportStatement=++de]="ExportStatement";e[e.BreakStatement=++de]="BreakStatement";e[e.ContinueStatement=++de]="ContinueStatement";e[e.FunctionExpression=++de]="FunctionExpression";e[e.FunctionDeclaration=++de]="FunctionDeclaration";e[e.VariableDeclaration=++de]="VariableDeclaration";e[e.Parameter=++de]="Parameter";e[e.Identifier=++de]="Identifier";e[e.Literal=++de]="Literal";e[e.Comment=++de]="Comment"})(Te),(e=>{e[e.EOF=++de]="EOF";e[e.Unknown=++de]="Unknown";e[e.Keyword=++de]="Keyword";e[e.Identifier=++de]="Identifier";e[e.BooleanLiteral=++de]="BooleanLiteral";e[e.NullLiteral=++de]="NullLiteral";e[e.StringLiteral=++de]="StringLiteral";e[e.NumericLiteral=++de]="NumericLiteral";e[e.HexadecimalLiteral=++de]="HexadecimalLiteral"})(Se),(e=>{e[e["("]=++de]="LPAREN";e[e[")"]=++de]="RPAREN";e[e["{"]=++de]="LBRACE";e[e["}"]=++de]="RBRACE";e[e[","]=++de]="COMMA";e[e[";"]=++de]="SEMICOLON";e[e.true=++de]="TRUE";e[e.false=++de]="FALSE";e[e.import=++de]="IMPORT";e[e.extern=++de]="EXPORT";e[e.break=++de]="BREAK";e[e.continue=++de]="CONTINUE";e[e.do=++de]="DO";e[e.else=++de]="ELSE";e[e.for=++de]="FOR";e[e.if=++de]="IF";e[e.return=++de]="RETURN";e[e.while=++de]="WHILE";e[e.int=++de]="INT";e[e.i32=++de]="INT32";e[e.i64=++de]="INT64";e[e.float=++de]="FLOAT";e[e.f32=++de]="FLOAT32";e[e.f64=++de]="FLOAT64";e[e.void=++de]="VOID";e[e.bool=++de]="BOOLEAN"})(Re),(e=>{e.LOWEST=++de;e.UNARY_POSTFIX=++de;e[e["="]=++de]="ASS";e[e["+="]=++de]="ADD_ASS";e[e["-="]=++de]="SUB_ASS";e[e["*="]=++de]="MUL_ASS";e[e["/="]=++de]="DIV_ASS";e[e["%="]=++de]="MOD_ASS";e[e["=>"]=++de]="CAST";e[e["||"]=++de]="OR";e[e["&&"]=++de]="AND";e[e["=="]=++de]="EQ";e[e["!="]=++de]="NEQ";e[e["<"]=++de]="LT";e[e["<="]=++de]="LE";e[e[">"]=++de]="GT";e[e[">="]=++de]="GE";e[e["+"]=++de]="ADD";e[e["-"]=++de]="SUB";e[e["*"]=++de]="MUL";e[e["/"]=++de]="DIV";e[e["%"]=++de]="MOD";e[e["&"]=++de]="BIN_AND";e[e["|"]=++de]="BIN_OR";e[e["!"]=++de]="NOT";e[e["--"]=++de]="DECR";e[e["++"]=++de]="INCR";e.UNARY_PREFIX=++de;e.HIGHEST=++de})(he),(()=>{const e=[Te,Se,Re,he];e.map(e=>{for(let t in e){const n=parseInt(t);if(!(n>=0))continue;const i=e[t].toUpperCase();e[i]=n}})})();const Le={OPCODE_UNREACHABLE:0,OPCODE_NOP:1,OPCODE_BLOCK:2,OPCODE_LOOP:3,OPCODE_IF:4,OPCODE_ELSE:5,OPCODE_END:11,OPCODE_BR:12,OPCODE_BR_IF:13,OPCODE_BR_TABLE:14,OPCODE_RETURN:15,OPCODE_CALL:16,OPCODE_CALL_INDIRECT:17,OPCODE_DROP:26,OPCODE_SELECT:27,OPCODE_GET_LOCAL:32,OPCODE_SET_LOCAL:33,OPCODE_TEE_LOCAL:34,OPCODE_GET_GLOBAL:35,OPCODE_SET_GLOBAL:36,OPCODE_I32_LOAD:40,OPCODE_I64_LOAD:41,OPCODE_F32_LOAD:42,OPCODE_F64_LOAD:43,OPCODE_I32_LOAD8_S:44,OPCODE_I32_LOAD8_U:45,OPCODE_I32_LOAD16_S:46,OPCODE_I32_LOAD16_U:47,OPCODE_I64_LOAD8_S:48,OPCODE_I64_LOAD8_U:49,OPCODE_I64_LOAD16_S:50,OPCODE_I64_LOAD16_U:51,OPCODE_I64_LOAD32_S:52,OPCODE_I64_LOAD32_U:53,OPCODE_I32_STORE:54,OPCODE_I64_STORE:55,OPCODE_F32_STORE:56,OPCODE_F64_STORE:57,OPCODE_I32_STORE8:58,OPCODE_I32_STORE16:59,OPCODE_I64_STORE8:60,OPCODE_I64_STORE16:61,OPCODE_I64_STORE32:62,OPCODE_CURRENT_MEMORY:63,OPCODE_GROW_MEMORY:64,OPCODE_I32_CONST:65,OPCODE_I64_CONST:66,OPCODE_F32_CONST:67,OPCODE_F64_CONST:68,OPCODE_I32_EQZ:69,OPCODE_I32_EQ:70,OPCODE_I32_NEQ:71,OPCODE_I32_LT_S:72,OPCODE_I32_LT_U:73,OPCODE_I32_GT_S:74,OPCODE_I32_GT_U:75,OPCODE_I32_LE_S:76,OPCODE_I32_LE_U:77,OPCODE_I32_GE_S:78,OPCODE_I32_GE_U:79,OPCODE_I64_EQZ:80,OPCODE_I64_EQ:81,OPCODE_I64_NE:82,OPCODE_I64_LT_S:83,OPCODE_I64_LT_U:84,OPCODE_I64_GT_S:85,OPCODE_I64_GT_U:86,OPCODE_I64_LE_S:87,OPCODE_I64_LE_U:88,OPCODE_I64_GE_S:89,OPCODE_I64_GE_U:90,OPCODE_F32_EQ:91,OPCODE_F32_NE:92,OPCODE_F32_LT:93,OPCODE_F32_GT:94,OPCODE_F32_LE:95,OPCODE_F32_GE:96,OPCODE_F64_EQ:97,OPCODE_F64_NE:98,OPCODE_F64_LT:99,OPCODE_F64_GT:100,OPCODE_F64_LE:101,OPCODE_F64_GE:102,OPCODE_I32_CLZ:103,OPCODE_I32_CTZ:104,OPCODE_I32_POPCNT:105,OPCODE_I32_ADD:106,OPCODE_I32_SUB:107,OPCODE_I32_MUL:108,OPCODE_I32_DIV_S:109,OPCODE_I32_DIV_U:110,OPCODE_I32_REM_S:111,OPCODE_I32_REM_U:112,OPCODE_I32_AND:113,OPCODE_I32_OR:114,OPCODE_I32_XOR:115,OPCODE_I32_SHL:116,OPCODE_I32_SHR_S:117,OPCODE_I32_SHR_U:118,OPCODE_I32_ROTL:119,OPCODE_I32_ROTR:120,OPCODE_I64_CLZ:121,OPCODE_I64_CTZ:122,OPCODE_I64_POPCNT:123,OPCODE_I64_ADD:124,OPCODE_I64_SUB:125,OPCODE_I64_MUL:126,OPCODE_I64_DIV_S:127,OPCODE_I64_DIV_U:128,OPCODE_I64_REM_S:129,OPCODE_I64_REM_U:130,OPCODE_I64_AND:131,OPCODE_I64_OR:132,OPCODE_I64_XOR:133,OPCODE_I64_SHL:134,OPCODE_I64_SHR_S:135,OPCODE_I64_SHR_U:136,OPCODE_I64_ROTL:137,OPCODE_I64_ROTR:138,OPCODE_F32_ABS:139,OPCODE_F32_NEG:140,OPCODE_F32_CEIL:141,OPCODE_F32_FLOOR:142,OPCODE_F32_TRUNC:143,OPCODE_F32_NEAREST:144,OPCODE_F32_SQRT:145,OPCODE_F32_ADD:146,OPCODE_F32_SUB:147,OPCODE_F32_MUL:148,OPCODE_F32_DIV:149,OPCODE_F32_MIN:150,OPCODE_F32_MAX:151,OPCODE_F32_COPYSIGN:152,OPCODE_F64_ABS:153,OPCODE_F64_NEG:154,OPCODE_F64_CEIL:155,OPCODE_F64_FLOOR:156,OPCODE_F64_TRUNC:157,OPCODE_F64_NEAREST:158,OPCODE_F64_SQRT:159,OPCODE_F64_ADD:160,OPCODE_F64_SUB:161,OPCODE_F64_MUL:162,OPCODE_F64_DIV:163,OPCODE_F64_MIN:164,OPCODE_F64_MAX:165,OPCODE_F64_COPYSIGN:166,OPCODE_I32_WRAP_I64:167,OPCODE_I32_TRUNC_S_F32:168,OPCODE_I32_TRUNC_U_F32:169,OPCODE_I32_TRUNC_S_F64:170,OPCODE_I32_TRUNC_U_F64:171,OPCODE_I64_EXTEND_S_I32:172,OPCODE_I64_EXTEND_U_I32:173,OPCODE_I64_TRUNC_S_F32:174,OPCODE_I64_TRUNC_U_F32:175,OPCODE_I64_TRUNC_S_F64:176,OPCODE_I64_TRUNC_U_F64:177,OPCODE_F32_CONVERT_S_I32:178,OPCODE_F32_CONVERT_U_I32:179,OPCODE_F32_CONVERT_S_I64:180,OPCODE_F32_CONVERT_U_I64:181,OPCODE_F32_DEMOTE_F64:182,OPCODE_F64_CONVERT_S_I32:183,OPCODE_F64_CONVERT_U_I32:184,OPCODE_F64_CONVERT_S_I64:185,OPCODE_F64_CONVERT_U_I64:186,OPCODE_F64_PROMOTE_F32:187,OPCODE_I32_REINTERPRET_F32:188,OPCODE_I64_REINTERPRET_F64:189,OPCODE_F32_REINTERPRET_I32:190,OPCODE_F64_REINTERPRET_I64:191,MAGIC:1836278016,VERSION:1,INITIAL_MEMORY:256,MAXIMUM_MEMORY:256,SECTION_TYPE:1,SECTION_FUNCTION:3,SECTION_TABLE:4,SECTION_MEMORY:5,SECTION_GLOBAL:6,SECTION_EXPORT:7,SECTION_ELEMENT:9,SECTION_CODE:10,TYPE_VOID:0,TYPE_I32:127,TYPE_I64:126,TYPE_F32:125,TYPE_F64:124,TYPE_CTOR_VOID:0,TYPE_CTOR_I32:127,TYPE_CTOR_I64:126,TYPE_CTOR_F32:125,TYPE_CTOR_F64:124,TYPE_CTOR_FUNC:96,TYPE_CTOR_ANYFUNC:112,TYPE_CTOR_BLOCK:64,EXTERN_FUNCTION:0,EXTERN_TABLE:1,EXTERN_MEMORY:2,EXTERN_GLOBAL:3,EXTERN_FUNC:3};class Ne extends Array{emitU8(e){this.push(255&e)}emitU16(e){this.push(255&e),this.push(e>>8&255)}emitU32(e){this.push(255&e),this.push(e>>8&255),this.push(e>>16&255),this.push(e>>24&255)}emitU32v(e){for(;;){let t=255&e;if(0==(e>>>=7)){this.push(t);break}this.push(128|t)}}emit32v(e){for(;;){var t=127&e,n=0===(e>>=7)&&0==(64&t)||-1===e&&0!=(64&t);if(n||(t|=128),this.push(255&t),n)break}}emitULEB128(e){let t=0;do{t=127&e,(e>>>=7)&&(t|=128),this.push(t)}while(e)}emitLEB128(e){let t=0;for(;;){let n=0!=(64&(t=127&e));if(0===(e>>>=7)&&!n||-1===e&&n){this.push(t);break}t|=128,this.push(t)}}patchLEB128(e,t){let n=0,i=0;for(;;){let r=0!=(64&(n=127&e));if(0===(e>>>=7)&&!r||-1===e&&r){this[t+i]=n;break}n|=128,this[t+i]=n,i++}}patchULEB128(e,t){let n=0,i=0;do{n=127&e,(e>>>=7)&&(n|=128),this[t+i]=n,i++}while(e)}createU32vPatch(){this.writeVarUnsigned(-1);let e=this.length;return{offset:e,patch:t=>{this.patchU32v(t,e-5)}}}patchU32v(e,t){for(var n=e>>>0,i=-1>>>0;;){var r=127&n;if(n>>>=7,0!==(i>>>=7)&&(r|=128),this[t]=255&r,t++,0===i)break}}writeVarUnsigned(e){for(var t=e>>>0;;){var n=127&t;if(0!==(t>>>=7)&&(n|=128),this.push(255&n),0===t)break}}createLEB128Patch(){let e=this.length;return this.emitU8(0),{offset:e,patch:t=>this.patchLEB128(t,e)}}createULEB128Patch(){let e=this.length;return this.emitU8(0),{offset:e,patch:t=>this.patchULEB128(t,e)}}emitUi32(e){e|=0,this.emitU8(Le.OPCODE_I32_CONST),this.writeVarUnsigned(e)}emitLoad32(){this.emitU8(Le.OPCODE_I32_LOAD),this.emitU8(2),this.writeVarUnsigned(0)}emitString(e){var t=0|e.length;this.emitU32v(t);this.length;for(var n=0;n<t;)this.push(255&e.charCodeAt(n)),n++}}class Ae{constructor(e=null){this.reset(e)}reset(e){this.bytes=new Ne,this.scope=null,this._global=null,this.pindex=0,this.tokens=null,this.current=null,this.__imports=e,this.currentHeapOffset=null}}var Fe=new Ae;let ke=!1;return function(e,t={log:console.log},n){Fe.reset(t);let i=c(J(e));te(i);let r=new Uint8Array(Fe.bytes),O=pe(r);if(!0===n){let e=new WebAssembly.Module(r),t=new WebAssembly.Instance(e);return{ast:i,dump:O,buffer:r,memory:t.exports.memory,instance:t,exports:t.exports}}return new Promise((e,t)=>{WebAssembly.instantiate(r).then(t=>{let n=t.instance;e({ast:i,dump:O,buffer:r,memory:n.exports.memory,instance:n,exports:n.exports})})})}});
